<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PropRiskGuard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #333;
    }
    header {
      background: #222;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    .paywall {
      text-align: center;
      padding: 50px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .paywall h2 {
      margin-bottom: 20px;
    }
    .pay-btn {
      background: #0a84ff;
      color: #fff;
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: 0.2s;
    }
    .pay-btn:hover {
      background: #006edc;
    }
    #appContent {
      display: none;
    }
    .hidden { display: none; }
    .chatbox {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      background: #fff;
      margin-top: 20px;
    }
    .chat-messages {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #eee;
      padding: 5px;
    }
    .chat-messages div {
      margin: 3px 0;
    }
    .chat-messages .me { color: #0a84ff; }
    .chat-messages .bot { color: #333; }
  </style>
</head>
<body>
<header>
  <h1>PropRiskGuard</h1>
  <p>Risk Management Tool for Traders</p>
</header>

<main>
  <!-- PAYWALL -->
  <div id="paywall" class="paywall">
    <h2>Unlock Full Access</h2>
    <p>Get unlimited access for only <b>£9.99</b></p>
    <button id="buyBtn" class="pay-btn">Buy & Unlock</button>
  </div>

  <!-- APP CONTENT -->
  <div id="appContent">
    <h2>Welcome to PropRiskGuard!</h2>
    <p>Now you have full access to the risk management dashboard.</p>

    <div>
      <label>Balance: <input id="balance" type="number" value="10000"></label>
      <label>P/L Today: <input id="plToday" type="number" value="0"></label>
      <label>Currency:
        <select id="ccy">
          <option value="USD" selected>USD</option>
          <option value="GBP">GBP</option>
          <option value="EUR">EUR</option>
        </select>
      </label>
    </div>

    <div>
      <label>Max Daily Loss %: <input id="mdlPct" type="number" value="5"></label>
      <label>Max Overall Loss %: <input id="molPct" type="number" value="10"></label>
    </div>

    <div>
      <label>Risk %: <input id="riskPct" type="number" value="1"></label>
      <label>Stop Loss (pips): <input id="slPips" type="number" value="30"></label>
      <label>Pip Value: <input id="pipVal" type="number" value="10"></label>
    </div>

    <div class="chatbox">
      <div class="chat-messages" id="chatMessages"></div>
      <input type="text" id="chatInput" placeholder="Ask about risk, lots, etc.">
      <button id="chatSend">Send</button>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const STRIPE_LINK = "https://buy.stripe.com/9B6aEQc3IcLM2y18r683C00"; // link Stripe
  const UNLOCK_KEY = "PRG-STRP-CHECK-42";

  // Elements
  const paywall = document.getElementById('paywall');
  const appContent = document.getElementById('appContent');
  const buyBtn = document.getElementById('buyBtn');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const chatMessages = document.getElementById('chatMessages');

  const balanceEl = document.getElementById('balance');
  const plTodayEl = document.getElementById('plToday');
  const ccyEl = document.getElementById('ccy');
  const mdlPctEl = document.getElementById('mdlPct');
  const molPctEl = document.getElementById('molPct');
  const riskPctEl = document.getElementById('riskPct');
  const slPipsEl = document.getElementById('slPips');
  const pipValEl = document.getElementById('pipVal');

  // Go to Stripe
  function gotoStripe(){
    if(!STRIPE_LINK){ alert("Stripe link not set"); return; }
    window.location.href = STRIPE_LINK + `?prefilled_email=test@example.com&client_reference_id=prguser`;
  }
  buyBtn.addEventListener('click', gotoStripe);

  // Unlock check
  const qs = new URLSearchParams(window.location.search);
  if(qs.has('unlock') && qs.get('unlock')===UNLOCK_KEY){
    localStorage.setItem('prg_unlocked', 'true');
  }
  if(localStorage.getItem('prg_unlocked')==='true'){
    paywall.style.display = 'none';
    appContent.style.display = 'block';
  }
    // --- Calculations ---
  function fmt(v){ return (ccyEl.value||'').toUpperCase() + ' ' + v.toFixed(2); }

  function calc(){
    const bal = parseFloat(balanceEl.value||0);
    const pl  = parseFloat(plTodayEl.value||0);
    const mdl = parseFloat(mdlPctEl.value||0)/100;
    const mol = parseFloat(molPctEl.value||0)/100;
    const riskPct = parseFloat(riskPctEl.value||0)/100;
    const sl = parseFloat(slPipsEl.value||0);
    const pip = parseFloat(pipValEl.value||0);

    const maxDaily = bal * mdl;
    const remaining = Math.max(0, maxDaily + pl);
    const overallMax = bal * mol;
    const lot = (sl>0 && pip>0) ? (bal * riskPct / (sl*pip)) : 0;

    return { bal, pl, mdl, mol, riskPct, sl, pip, maxDaily, remaining, overallMax, lot };
  }

  // --- Chat Bot ---
  function addMsg(text, cls){
    const d=document.createElement('div');
    d.className=cls;
    d.innerHTML=text;
    chatMessages.appendChild(d);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  }

  function botReply(q){
    const ql = q.toLowerCase();
    const {bal,pl,mdl,mol,riskPct,sl,pip,maxDaily,remaining,overallMax,lot} = calc();

    if(ql.includes('help')||ql==='?') return 'Try: <b>remaining</b>, <b>max daily</b>, <b>overall</b>, <b>lot</b>, or “risk 1% with 30 pips”.';
    if(ql.includes('remaining')) return `You can still lose <b>${fmt(remaining)}</b> today before breaching the daily limit.`;
    if(ql.includes('max daily')) return `Max Daily Loss is <b>${fmt(maxDaily)}</b>.`;
    if(ql.includes('overall')) return `Overall max loss allowed is <b>${fmt(overallMax)}</b>.`;
    if(ql.includes('lot')) return `With risk ${(riskPct*100).toFixed(2)}%, SL ${sl} pips, pip=${pip}, lot ≈ <b>${ isFinite(lot)? (lot>=1?lot.toFixed(2):lot.toFixed(3)) : '—' }</b>.`;

    const m=ql.match(/risk\s*([0-9.]+)\s*%.*?(\d+)\s*(pip|pips)/);
    if(m){
      const r=parseFloat(m[1])/100;
      const slGuess=parseFloat(m[2]);
      const lotG=(slGuess>0&&pip>0)?(bal*r/(slGuess*pip)):0;
      return `At risk ${m[1]}% and SL ${slGuess} pips, lot ≈ <b>${ isFinite(lotG)? (lotG>=1?lotG.toFixed(2):lotG.toFixed(3)) : '—' }</b>.`;
    }
    return "Got it. Type <b>help</b> for examples.";
  }

  function send(){
    const t=(chatInput?.value||'').trim();
    if(!t) return;
    addMsg(t,'me'); 
    addMsg(botReply(t),'bot');
    chatInput.value='';
  }

  chatSend?.addEventListener('click',send);
  chatInput?.addEventListener('keydown',e=>{
    if(e.key==='Enter'){ e.preventDefault(); send(); }
  });

  // Init
  [balanceEl, plTodayEl, riskPctEl, slPipsEl, pipValEl, mdlPctEl, molPctEl]
    .forEach(el=> el?.addEventListener('input', calc));

  calc();
});
</script>
</body>
</html>
